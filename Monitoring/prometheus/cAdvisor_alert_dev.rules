groups:
- name: service
  rules:
  # Alert for any instance that is unreachable for >30s.
  - alert: instance_down
    expr: up == 0
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Instance {{ $labels.instance }} down on machine 10.145.7.48"
      description: "{{ $labels.instance }} of job {{ $labels.job }} is down."

- name: host
  rules:
  - alert: high_cpu_load
    expr: node_load1 > 25
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Server under high load on machine 10.145.7.48"
      description: "Docker host is under high load, the avg load 1m is at {{ $value}}. Reported by instance {{ $labels.instance }} of job {{ $labels.job }}."

  - alert: high_memory_load
    expr: (sum(node_memory_MemTotal_bytes) - sum(node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / sum(node_memory_MemTotal_bytes) * 100 > 75 
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Server memory is almost full on machine 10.145.7.48"
      description: "Docker host memory usage is {{ humanize $value}}%. Reported by instance {{ $labels.instance }} of job {{ $labels.job }}."

  - alert: high_storage_load
    expr: 100 - ((node_filesystem_avail_bytes{mountpoint="/rootfs/var/lib/docker"}/node_filesystem_size_bytes{mountpoint="/rootfs/var/lib/docker"}) * 100) > 80 
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Server storage is almost full on machine 10.145.7.48"
      description: "Docker host storage usage is {{ humanize $value}}%. Reported by instance {{ $labels.instance }} of job {{ $labels.job }}."


- name: containers
  rules:
  - alert: ode_container_down
    expr: docker_container_running_state{name=~"ode-.*",name!~"ode-kafka_init-1"} < 1
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "ODE container is down on machine 10.145.7.48"
      description: "ODE Docker container {{$labels.name}} is down."

  - alert: wyocv_container_down
    expr: docker_container_running_state{name=~"wyocv-.*"} < 1
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "WyoCV container is down on machine 10.145.7.48"
      description: "WyoCV Docker container {{$labels.name}} is down."

  - alert: cvmanager_container_down
    expr: docker_container_running_state{name=~"jpo-cvmanager-.*"} < 1
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "CV Manager container is down on machine 10.145.7.48"
      description: "CV Manager Docker container {{$labels.name}} is down."
